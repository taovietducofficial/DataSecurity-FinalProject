-- B?ng Resident: Thông tin c? dân


CREATE TABLE Resident (
    ResidentID        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- S? d?ng IDENTITY cho t? ??ng t?ng
    FullName          VARCHAR2(100) NOT NULL,
    Gender            CHAR(1) CHECK (Gender IN ('M', 'F')), -- Ràng bu?c gi?i tính
    Address           VARCHAR2(255),
    District          VARCHAR2(50) NOT NULL,
    IDCardNumber      VARCHAR2(15) UNIQUE NOT NULL,
    PhoneNumber       VARCHAR2(15) UNIQUE, -- S? ?i?n tho?i ph?i duy nh?t (n?u c?n)
    Email             VARCHAR2(100) UNIQUE, -- Email ph?i duy nh?t
    PassportNumber    VARCHAR2(15) UNIQUE -- S? h? chi?u duy nh?t (n?u c?n)
);

select * from Resident;

-- B?ng PassportRenewalRequest: Yêu c?u gia h?n h? chi?u
CREATE TABLE PassportRenewalRequest (
    RequestID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- ID t? ??ng t?ng
    ResidentID        NUMBER NOT NULL REFERENCES Resident(ResidentID) ON DELETE CASCADE, -- T? ??ng xóa khi Resident b? xóa
    SubmissionDate    DATE DEFAULT SYSDATE NOT NULL,
    Status            VARCHAR2(20) NOT NULL CHECK (Status IN (
        'Pending Verification', 'Verified', 'Under Review', 'Approved', 'Rejected'
    )), -- Tr?ng thái ph?i h?p l?
    VerificationUnit  VARCHAR2(10),
    ReviewComments    VARCHAR2(255)
);

select * from PassportRenewalRequest;

DELETE FROM PassportRenewalRequest;

INSERT INTO PassportRenewalRequest (ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments)
VALUES (1, TO_DATE('10-DEC-24', 'DD-MON-YY'), 'Pending Verification', 'V001', 'Awaiting verification');

INSERT INTO PassportRenewalRequest (ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments)
VALUES (2, TO_DATE('11-DEC-24', 'DD-MON-YY'), 'Verified', 'V002', 'All details verified');

INSERT INTO PassportRenewalRequest (ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments)
VALUES (3, TO_DATE('12-DEC-24', 'DD-MON-YY'), 'Under Review', 'V003', 'Pending approval');

INSERT INTO PassportRenewalRequest (ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments)
VALUES (5, TO_DATE('16-DEC-24', 'DD-MON-YY'), 'Under Review', 'V005', 'Review in progress');

INSERT INTO PassportRenewalRequest (ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments)
VALUES (6, TO_DATE('17-DEC-24', 'DD-MON-YY'), 'Approved', 'V006', 'Request approved successfully');


SELECT
    pr.RequestID,
    r.ResidentID,
    r.fullName,
    r.gender,
    r.address,
    r.district,
    r.idCardNumber,
    r.phoneNumber,
    r.email,
    r.passportNumber,
    pr.SubmissionDate,
    pr.Status,
    pr.VerificationUnit,
    pr.ReviewComments
FROM
    PassportRenewalRequest pr
JOIN
    Resident r ON pr.ResidentID = r.ResidentID;

-- B?ng VerificationUnit: ??n v? xác minh
CREATE TABLE VerificationUnit (
    UnitID            VARCHAR2(10) PRIMARY KEY,
    District          VARCHAR2(50) UNIQUE NOT NULL -- M?i District ch? có m?t ??n v? xác minh
);

-- B?ng Approval: Phê duy?t yêu c?u
CREATE TABLE Approval (
    ApprovalID        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- ID t? ??ng t?ng
    RequestID         NUMBER NOT NULL REFERENCES PassportRenewalRequest(RequestID) ON DELETE CASCADE,
    IsApproved        CHAR(1) NOT NULL CHECK (IsApproved IN ('Y', 'N')), -- Ch? Y/N
    ApprovalDate      DATE DEFAULT SYSDATE NOT NULL,
    ReviewerComments  VARCHAR2(255)
);

select * from Approval;
DESCRIBE approval;

DROP SEQUENCE request_id_seq;
DROP TRIGGER request_id_trigger;


CREATE SEQUENCE request_id_seq START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER request_id_trigger
BEFORE INSERT ON APPROVAL
FOR EACH ROW
BEGIN
  IF :new.REQUESTID IS NULL THEN
    SELECT request_id_seq.NEXTVAL INTO :new.REQUESTID FROM dual;
  END IF;
END;


-- B?ng Renewal: Gia h?n h? chi?u
CREATE TABLE Renewal (
    RenewalID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- ID t? ??ng t?ng
    RequestID         NUMBER NOT NULL REFERENCES PassportRenewalRequest(RequestID) ON DELETE CASCADE,
    NewExpiryDate     DATE NOT NULL, -- Ngày h?t h?n m?i
    UpdatedAt         DATE DEFAULT SYSDATE NOT NULL
);

select * from Renewal;
DESC renewal;
SELECT column_name
FROM all_tab_columns
WHERE table_name = 'RENEWAL' AND column_name = 'NewExpiryDate';


-- B?ng ActivityLog: Nh?t ký ho?t ??ng
CREATE TABLE ActivityLog (
    LogID             NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- ID t? ??ng t?ng
    RequestID         NUMBER NOT NULL REFERENCES PassportRenewalRequest(RequestID) ON DELETE CASCADE,
    Status            VARCHAR2(20) NOT NULL, -- Tr?ng thái liên quan
    ActionTimestamp   DATE DEFAULT SYSDATE NOT NULL,
    PerformedBy       VARCHAR2(50) NOT NULL -- Ng??i th?c hi?n hành ??ng
);

select * from ActivityLog;


DROP TABLE Resident CASCADE CONSTRAINTS;
DROP TABLE PassportRenewalRequest CASCADE CONSTRAINTS;
DROP TABLE VerificationUnit CASCADE CONSTRAINTS;
DROP TABLE Approval CASCADE CONSTRAINTS;
DROP TABLE Renewal CASCADE CONSTRAINTS;
DROP TABLE ActivityLog CASCADE CONSTRAINTS;



-- T?o sequence ActivityLog_seq
CREATE SEQUENCE ActivityLog_seq
START WITH 1
INCREMENT BY 1
NOCACHE;


-- Triggers to maintain security and audit logs
CREATE OR REPLACE TRIGGER trg_VerifyStatusChange
BEFORE UPDATE ON PassportRenewalRequest
FOR EACH ROW
BEGIN
    INSERT INTO ActivityLog (LogID, RequestID, Status, PerformedBy)
    VALUES (ActivityLog_seq.NEXTVAL, :NEW.RequestID, :NEW.Status, USER);
END;
/

-- Synonyms for role-based access
CREATE SYNONYM XT_Resident FOR Resident;
CREATE SYNONYM XT_PassportRenewalRequest FOR PassportRenewalRequest;

CREATE SYNONYM XD_PassportRenewalRequest FOR PassportRenewalRequest;

CREATE SYNONYM LT_Renewal FOR Renewal;
CREATE SYNONYM LT_Approval FOR Approval;

-- View to restrict [XT] to district-specific data
CREATE OR REPLACE VIEW XT_View AS
SELECT 
    PR.RequestID, 
    PR.ResidentID, 
    PR.SubmissionDate, 
    PR.Status, 
    R.FullName AS ResidentName,  -- S? d?ng FullName thay vì Name
    R.District AS ResidentDistrict
FROM PassportRenewalRequest PR
JOIN Resident R ON PR.ResidentID = R.ResidentID
WHERE R.District = (
    SELECT District 
    FROM VerificationUnit 
    WHERE UnitID = SYS_CONTEXT('USERENV', 'SESSION_USER')
);

-- View to restrict [XD] to request form only
CREATE OR REPLACE VIEW XD_View AS
SELECT 
    RequestID, 
    ResidentID, 
    SubmissionDate, 
    Status
FROM PassportRenewalRequest;

-- View for [LT] to see only approved data
CREATE OR REPLACE VIEW LT_View AS
SELECT 
    A.RequestID, 
    A.IsApproved, 
    A.ApprovalDate, 
    Ren.NewExpiryDate
FROM Approval A
JOIN Renewal Ren ON A.RequestID = Ren.RequestID
WHERE A.IsApproved = 'Y';


-- T?o ng??i dùng cho XT_ROLE và c?p m?t kh?u
CREATE USER C##XT_USER IDENTIFIED BY 123;
GRANT CREATE SESSION TO C##XT_USER;
GRANT C##XT_ROLE TO C##XT_USER;

-- T?o ng??i dùng cho XD_ROLE và c?p m?t kh?u
CREATE USER C##XD_USER IDENTIFIED BY 1234;
GRANT CREATE SESSION TO C##XD_USER;
GRANT C##XD_ROLE TO C##XD_USER;

-- T?o ng??i dùng cho LT_ROLE và c?p m?t kh?u
CREATE USER C##LT_USER IDENTIFIED BY 12345;
GRANT CREATE SESSION TO C##LT_USER;
GRANT C##LT_ROLE TO C##LT_USER;

-- T?o ng??i dùng cho GS_ROLE và c?p m?t kh?u
CREATE USER C##GS_USER IDENTIFIED BY 123456;
GRANT CREATE SESSION TO C##GS_USER;
GRANT C##GS_ROLE TO C##GS_USER;

-- C?p quy?n cho các vai trò
GRANT SELECT ON Resident TO C##XT_USER;
GRANT SELECT ON PassportRenewalRequest TO C##XD_USER;
GRANT SELECT ON Approval TO C##LT_USER;
GRANT UPDATE ON Renewal TO C##LT_USER;
GRANT SELECT ON ActivityLog TO C##GS_USER;

GRANT SELECT ON SCHEMA_NAME.Resident TO C##XT_USER;


-- Ki?m tra quy?n c?a ng??i dùng XT_ROLE
SELECT * FROM XT_Resident;

-- Ki?m tra quy?n c?a ng??i dùng XD_ROLE
SELECT * FROM XD_View;

-- Ki?m tra quy?n c?a ng??i dùng LT_ROLE
SELECT * FROM LT_View;



-- Chèn t?ng dòng vào b?ng Resident
INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (1, 'Nguyen Minh Tu', 'M', '123 Tran Hung Dao', 'District A', '123456789', '0123456789', 'tu.nguyen@example.com', 'P987654');

INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (2, 'Tran Thi Mai', 'F', '456 Le Lai', 'District B', '987654321', '0234567890', 'mai.tran@example.com', 'P321456');

INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (3, 'Hoang Thanh Son', 'M', '789 Hoang Hoa Tham', 'District C', '135792468', '0345678901', 'son.hoang@example.com', 'P654789');

INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (5, 'Nguyen Hoai Thu', 'F', '456 Nguyen Trai', 'District B', '234567890', '0456789012', 'thu.nguyen@example.com', 'P987321');

INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (6, 'Phan Duy Khanh', 'M', '789 Tan Phu', 'District C', '567890123', '0567890123', 'khannhphan@example.com', 'P741369');

INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (4, 'Tao Viet D?c', 'M', 'Long An', 'Duc Hoa', '567890126', '0971467418', 'taovietduc@gmail.com', 'P741370');

SELECT * FROM Resident;



-- D? li?u cho b?ng VerificationUnit
DELETE FROM VerificationUnit WHERE UnitID IN ('V001', 'V002', 'V003', 'V004', 'V005', 'V006');

INSERT INTO VerificationUnit (UnitID, District) VALUES ('V001', 'District A');
INSERT INTO VerificationUnit (UnitID, District) VALUES ('V002', 'District B');
INSERT INTO VerificationUnit (UnitID, District) VALUES ('V003', 'District C');
INSERT INTO VerificationUnit (UnitID, District) VALUES ('V004', 'District D');
INSERT INTO VerificationUnit (UnitID, District) VALUES ('V005', 'District E');
INSERT INTO VerificationUnit (UnitID, District) VALUES ('V006', 'District F');

SELECT * FROM VerificationUnit;

-- D? li?u cho b?ng PassportRenewalRequest
INSERT INTO PassportRenewalRequest (RequestID, ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments) 
VALUES (1, 1, TO_DATE('2024-12-10', 'YYYY-MM-DD'), 'Pending Verification', 'V001', 'Awaiting verification');

INSERT INTO PassportRenewalRequest (RequestID, ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments) 
VALUES (2, 2, TO_DATE('2024-12-11', 'YYYY-MM-DD'), 'Verified', 'V002', 'All details verified');

INSERT INTO PassportRenewalRequest (RequestID, ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments) 
VALUES (3, 3, TO_DATE('2024-12-12', 'YYYY-MM-DD'), 'Under Review', 'V003', 'Pending approval');


INSERT INTO PassportRenewalRequest (RequestID, ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments) 
VALUES (5, 5, TO_DATE('2024-12-16', 'YYYY-MM-DD'), 'Under Review', 'V005', 'Review in progress');

INSERT INTO PassportRenewalRequest (RequestID, ResidentID, SubmissionDate, Status, VerificationUnit, ReviewComments) 
VALUES (6, 6, TO_DATE('2024-12-17', 'YYYY-MM-DD'), 'Approved', 'V006', 'Request approved successfully');

SELECT * FROM PassportRenewalRequest;

-- D? li?u cho b?ng Approval
INSERT INTO Approval (ApprovalID, RequestID, IsApproved, ApprovalDate, ReviewerComments) 
VALUES (1, 1, 'Y', TO_DATE('2024-12-12', 'YYYY-MM-DD'), 'Approved after verification');

INSERT INTO Approval (ApprovalID, RequestID, IsApproved, ApprovalDate, ReviewerComments) 
VALUES (2, 2, 'N', TO_DATE('2024-12-13', 'YYYY-MM-DD'), 'Rejected due to missing documents');

INSERT INTO Approval (ApprovalID, RequestID, IsApproved, ApprovalDate, ReviewerComments) 
VALUES (4, 5, 'Y', TO_DATE('2024-12-17', 'YYYY-MM-DD'), 'Approved after verification');

SELECT * FROM Approval;

-- D? li?u cho b?ng Renewal
INSERT INTO Renewal (RenewalID, RequestID, NewExpiryDate, UpdatedAt) 
VALUES (1, 2, TO_DATE('2029-12-11', 'YYYY-MM-DD'), SYSDATE);

INSERT INTO Renewal (RenewalID, RequestID, NewExpiryDate, UpdatedAt) 
VALUES (2, 3, TO_DATE('2030-12-12', 'YYYY-MM-DD'), SYSDATE);

INSERT INTO Renewal (RenewalID, RequestID, NewExpiryDate, UpdatedAt) 
VALUES (3, 5, TO_DATE('2029-12-16', 'YYYY-MM-DD'), SYSDATE);

INSERT INTO Renewal (RenewalID, RequestID, NewExpiryDate, UpdatedAt) 
VALUES (4, 6, TO_DATE('2031-12-17', 'YYYY-MM-DD'), SYSDATE);

SELECT * FROM Renewal;

-- D? li?u cho b?ng ActivityLog
INSERT INTO ActivityLog (LogID, RequestID, Status, ActionTimestamp, PerformedBy) 
VALUES (1, 1, 'Pending Verification', SYSDATE, 'admin');

INSERT INTO ActivityLog (LogID, RequestID, Status, ActionTimestamp, PerformedBy) 
VALUES (2, 2, 'Verified', SYSDATE, 'admin');

INSERT INTO ActivityLog (LogID, RequestID, Status, ActionTimestamp, PerformedBy) 
VALUES (3, 3, 'Under Review', SYSDATE, 'reviewer1');


INSERT INTO ActivityLog (LogID, RequestID, Status, ActionTimestamp, PerformedBy) 
VALUES (5, 5, 'Under Review', SYSDATE, 'reviewer3');

INSERT INTO ActivityLog (LogID, RequestID, Status, ActionTimestamp, PerformedBy) 
VALUES (6, 6, 'Approved', SYSDATE, 'reviewer4');


SELECT * FROM ActivityLog;

SELECT * FROM all_tables WHERE table_name = 'RESIDENT';

SELECT * 
FROM DBA_TAB_PRIVS
WHERE table_name = 'RESIDENT' AND grantee = 'C##XT_ROLE';

GRANT SELECT ON Resident TO C##XT_USER;

SELECT table_name FROM all_tables WHERE owner = 'C##XT_USER';


CONNECT C##XT_USER/123;

SELECT * FROM RESIDENT;

SELECT table_name
FROM all_tables
WHERE table_name = 'RESIDENT';

SELECT COUNT(*) FROM Resident;


CREATE USER C##XT_USER IDENTIFIED BY 123;
GRANT SELECT ON system.RESIDENT TO C##XT_USER;
GRANT SELECT ON system.PassportRenewalRequest TO C##XT_USER;
GRANT CONNECT TO C##XT_USER;
SELECT * FROM system.Resident;
SELECT * FROM system.PassportRenewalRequest;

SELECT USER FROM dual;

CREATE USER C##XD_USER IDENTIFIED BY 1234;
GRANT SELECT ON system.PassportRenewalRequest TO C##XD_USER;
GRANT CONNECT TO C##XD_USER;
SELECT * FROM system.PassportRenewalRequest;


CREATE USER C##LT_USER IDENTIFIED BY 12345;
GRANT SELECT ON system.Approval TO C##LT_USER;
-- T?o VIEW ch? ch?a c?t ApprovalDate
CREATE OR REPLACE VIEW Approval_View AS
SELECT ApprovalDate
FROM Approval;
GRANT UPDATE ON Approval_View TO C##LT_USER;
GRANT CONNECT TO C##LT_USER;
SELECT * FROM system.Approval;

CREATE USER C##GS_USER IDENTIFIED BY 123456;
GRANT SELECT ON system.PassportRenewalRequest TO C##GS_USER;
GRANT SELECT ON system.ActivityLog TO C##GS_USER;
GRANT CONNECT TO C##GS_USER;
SELECT * FROM system.PassportRenewalRequest;
SELECT * FROM system.ActivityLog;


INSERT INTO Resident (ResidentID, FullName, Gender, Address, District, IDCardNumber, PhoneNumber, Email, PassportNumber) 
VALUES (11, 'Tao Viet A', 'M', 'Long An', 'Duc Hoa', '567890130', '0971467425', 'taovieta@gmail.com', 'P7414025');